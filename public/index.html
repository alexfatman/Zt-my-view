<!DOCTYPE html>
<html lang="en" id="html-root">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ZeroTier Members</title>
  <style>
    :root {
      --bg: #ffffff;
      --text: #000000;
      --border: #ddd;
      --header-bg: #f8f9fa;
      --hover-bg: #f1f1f1;
      --shadow: rgba(0,0,0,0.1);
      --primary: #0d6efd;
    }

    [data-theme="dark"] {
      --bg: #121212;
      --text: #e0e0e0;
      --border: #444;
      --header-bg: #1e1e1e;
      --hover-bg: #2a2a2a;
      --shadow: rgba(0,0,0,0.3);
    }

    * { box-sizing: border-box; }
    body {
      font-family: system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 16px;
      transition: background 0.3s, color 0.3s;
    }

    .container { max-width: 1000px; margin: 0 auto; }
    .hidden { display: none !important; }

    /* Login form */
    .login-form {
      background: var(--header-bg);
      padding: 24px;
      border-radius: 10px;
      box-shadow: 0 4px 12px var(--shadow);
      max-width: 400px;
      margin: 40px auto;
    }
    .login-form input {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border: 1px solid var(--border);
      border-radius: 4px;
      background: var(--bg);
      color: var(--text);
    }
    .login-form button {
      width: 100%;
      padding: 10px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 12px;
    }

    /* Main UI */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 16px;
    }
    .controls { display: flex; gap: 10px; flex-wrap: wrap; }
    button { padding: 6px 12px; cursor: pointer; border: 1px solid var(--border); border-radius: 6px; background: var(--header-bg); }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { padding: 10px; text-align: left; border-bottom: 1px solid var(--border); }
    th { background: var(--header-bg); cursor: pointer; }
    @media (max-width: 600px) {
      table { display: block; overflow-x: auto; }
      th, td { padding: 8px 6px; font-size: 0.9rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Login Screen -->
    <div id="login-screen">
      <div class="login-form">
        <h2>–í—Ö–æ–¥</h2>
        <input type="text" id="username" placeholder="–õ–æ–≥–∏–Ω" autocomplete="username">
        <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å" autocomplete="current-password">
        <button onclick="attemptLogin()">–í–æ–π—Ç–∏</button>
        <div id="login-error" style="color: red; margin-top: 8px; min-height: 20px;"></div>
      </div>
    </div>

    <!-- Main App -->
    <div id="app" class="hidden">
      <header>
        <h1>ZeroTier Network Members</h1>
        <div class="controls">
          <button id="theme-toggle">üåì –¢–µ–º–∞</button>
          <button id="logout">–í—ã–π—Ç–∏</button>
        </div>
      </header>

      <div id="status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      <div style="overflow-x: auto;">
        <table id="members-table" class="hidden">
          <thead>
            <tr>
              <th data-sort="name">–ò–º—è ‚ñº</th>
              <th data-sort="internalIp">–í–Ω—É—Ç—Ä. IP ‚ñº</th>
              <th data-sort="externalIp">–í–Ω–µ—à–Ω–∏–π IP ‚ñº</th>
              <th data-sort="lastSeenRel">–ü–æ—Å–ª–µ–¥–Ω–∏–π –æ–Ω–ª–∞–π–Ω ‚ñº</th>
            </tr>
          </thead>
          <tbody id="table-body"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // === –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ===
    function timeAgo(dateStr) {
      if (dateStr === '‚Äî') return '‚Äî';
      const date = new Date(dateStr);
      const seconds = Math.floor((new Date() - date) / 1000);
      if (seconds < 60) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
      const intervals = [
        { div: 31536000, unit: '–≥–æ–¥' },
        { div: 2592000, unit: '–º–µ—Å' },
        { div: 86400, unit: '–¥–µ–Ω—å' },
        { div: 3600, unit: '—á–∞—Å' },
        { div: 60, unit: '–º–∏–Ω' }
      ];
      for (const { div, unit } of intervals) {
        const count = Math.floor(seconds / div);
        if (count >= 1) {
          const forms = unit === '–¥–µ–Ω—å' ? ['–¥–µ–Ω—å', '–¥–Ω—è', '–¥–Ω–µ–π'] :
                       unit === '—á–∞—Å' ? ['—á–∞—Å', '—á–∞—Å–∞', '—á–∞—Å–æ–≤'] :
                       unit === '–º–∏–Ω' ? ['–º–∏–Ω—É—Ç–∞', '–º–∏–Ω—É—Ç—ã', '–º–∏–Ω—É—Ç'] :
                       unit === '–≥–æ–¥' ? ['–≥–æ–¥', '–≥–æ–¥–∞', '–ª–µ—Ç'] :
                       ['–º–µ—Å—è—Ü', '–º–µ—Å—è—Ü–∞', '–º–µ—Å—è—Ü–µ–≤'];
          let form;
          if (count % 10 === 1 && count % 100 !== 11) form = forms[0];
          else if ([2,3,4].includes(count % 10) && ![12,13,14].includes(count % 100)) form = forms[1];
          else form = forms[2];
          return `${count} ${form} –Ω–∞–∑–∞–¥`;
        }
      }
      return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
    }

    // === –¢–µ–º–∞ ===
    const htmlRoot = document.documentElement;
    const savedTheme = localStorage.getItem('theme') || 'light';
    htmlRoot.setAttribute('data-theme', savedTheme);

    document.getElementById('theme-toggle').onclick = () => {
      const current = htmlRoot.getAttribute('data-theme');
      const next = current === 'dark' ? 'light' : 'dark';
      htmlRoot.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
      document.getElementById('theme-toggle').textContent = next === 'dark' ? '‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è' : 'üåô –¢—ë–º–Ω–∞—è';
    };
    document.getElementById('theme-toggle').textContent = savedTheme === 'dark' ? '‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è' : 'üåô –¢—ë–º–Ω–∞—è';

    // === –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è ===
    function attemptLogin() {
      const user = document.getElementById('username').value;
      const pass = document.getElementById('password').value;
      document.getElementById('login-error').textContent = '';

      fetch('/api/auth', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: user, password: pass })
      })
      .then(res => {
        if (res.ok) return res.json();
        else throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å');
      })
      .then(() => {
        localStorage.setItem('authenticated', 'true');
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        loadMembers();
      })
      .catch(err => {
        document.getElementById('login-error').textContent = err.message;
      });
    }

    document.getElementById('logout').onclick = () => {
      localStorage.removeItem('authenticated');
      document.getElementById('app').classList.add('hidden');
      document.getElementById('login-screen').classList.remove('hidden');
      document.getElementById('username').value = '';
      document.getElementById('password').value = '';
    };

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Å—Å–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    if (localStorage.getItem('authenticated') === 'true') {
      document.getElementById('login-screen').classList.add('hidden');
      document.getElementById('app').classList.remove('hidden');
loadMembers();
    }

    // === –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö ===
    let membersData = [];
    let currentSort = { key: 'name', dir: 1 };
    let autoRefreshInterval;

    function renderTable() {
      const tbody = document.getElementById('table-body');
      tbody.innerHTML = '';

      const sorted = [...membersData].sort((a, b) => {
        let aVal = a[currentSort.key] || '';
        let bVal = b[currentSort.key] || '';

        if (currentSort.key === 'lastSeenRel') {
          aVal = a.lastSeenRaw;
          bVal = b.lastSeenRaw;
        }

        if (aVal instanceof Date && bVal instanceof Date) {
          return (aVal - bVal) * currentSort.dir;
        }

        if (typeof aVal === 'string') aVal = aVal.toLowerCase();
        if (typeof bVal === 'string') bVal = bVal.toLowerCase();

        if (aVal < bVal) return -1 * currentSort.dir;
        if (aVal > bVal) return 1 * currentSort.dir;
        return 0;
      });

      if (sorted.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
        return;
      }

      sorted.forEach(m => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${m.name || '‚Äî'}</td>
          <td>${m.internalIp || '‚Äî'}</td>
          <td>${m.externalIp || '‚Äî'}</td>
          <td>${m.lastSeenRel}</td>
        `;
        tbody.appendChild(row);
      });
    }

    function setSortIndicator() {
      document.querySelectorAll('th').forEach(th => {
        const key = th.getAttribute('data-sort');
        let text = th.textContent.replace(/ [‚ñº‚ñ≤]$/, '');
        if (key === currentSort.key) {
          const symbol = currentSort.dir === 1 ? ' ‚ñ≤' : ' ‚ñº';
          th.textContent = text + symbol;
        } else {
          th.textContent = text + ' ‚ñº';
        }
      });
    }

    document.querySelectorAll('th').forEach(th => {
      th.addEventListener('click', () => {
        const key = th.getAttribute('data-sort');
        if (currentSort.key === key) {
          currentSort.dir *= -1;
        } else {
          currentSort = { key, dir: 1 };
        }
        setSortIndicator();
        renderTable();
      });
    });

    function loadMembers() {
      clearInterval(autoRefreshInterval);
      document.getElementById('status').textContent = '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';

      fetch('/api/members')
        .then(res => {
          if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
          return res.json();
        })
        .then(members => {
          membersData = members.map(m => {
            let lastSeenRaw = null;
            let lastSeenRel = '‚Äî';
            if (m.lastSeen && m.lastSeen !== '‚Äî') {
              lastSeenRaw = new Date(m.lastSeen);
              lastSeenRel = timeAgo(m.lastSeen);
            }
            return { ...m, lastSeenRaw, lastSeenRel };
          });
          document.getElementById('status').textContent = `–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${new Date().toLocaleTimeString()}`;
          document.getElementById('members-table').classList.remove('hidden');
          setSortIndicator();
          renderTable();

          // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
          autoRefreshInterval = setInterval(loadMembers, 30_000);
        })
        .catch(err => {
          document.getElementById('status').textContent = `‚ùå –û—à–∏–±–∫–∞: ${err.message}`;
        });
    }

    // === API Auth Endpoint (–Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ Vercel) ===
    // –ë—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –≤ /api/auth.js
  </script>
</body>
</html>